<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>毛概答题练习</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        /* 布局容器 */
        .wrapper {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        /* 左侧主内容 */
        .main-content {
            flex: 1;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* 右侧答题卡 */
        .sidebar {
            width: 300px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 20px;
            height: fit-content;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            position: sticky;
            top: 20px;
        }

        .header {
            background: #4a5568;
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 1.5em;
            margin-bottom: 5px;
        }

        .chapter-selector {
            padding: 15px 20px;
            background: #f7fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .chapter-selector label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2d3748;
        }

        .chapter-selector select {
            width: 100%;
            padding: 10px;
            border: 2px solid #cbd5e0;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            cursor: pointer;
        }

        .question-container {
            padding: 30px;
            min-height: 300px;
        }

        .question-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .question-number {
            color: #718096;
            font-size: 14px;
        }

        .question-text {
            font-size: 18px;
            line-height: 1.6;
            margin-bottom: 25px;
            color: #2d3748;
            font-weight: 500;
            white-space: pre-line;
        }

        .options {
            margin-bottom: 30px;
        }

        .option {
            margin-bottom: 12px;
            padding: 15px;
            background: #f8f9fa;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }

        .option:hover {
            background: #edf2f7;
            border-color: #cbd5e0;
        }

        .option.selected {
            background: #e6fffa;
            border-color: #48bb78;
        }
        .option.multiple-selected {
            background: #ebf8ff;
            border-color: #4299e1;
        }

        .option.correct {
            background: #c6f6d5;
            border-color: #48bb78;
        }

        .option.incorrect {
            background: #fed7d7;
            border-color: #f56565;
        }

        .material-answer-box {
            padding: 20px;
            background: #f0f4f8;
            border-radius: 8px;
            margin-top: 15px;
            white-space: pre-line;
            display: none;
            border-left: 4px solid #4299e1;
        }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 100px;
        }

        .submit-btn {
            background: #48bb78;
            color: white;
        }
        .submit-btn:hover:not(:disabled) {
            background: #38a169;
            transform: translateY(-2px);
        }
        .submit-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
        }

        .nav-btn {
            background: #4299e1;
            color: white;
        }
        .nav-btn:hover {
            background: #3182ce;
            transform: translateY(-2px);
        }

        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
        }
        .result.correct { background: #c6f6d5; color: #2f855a; }
        .result.incorrect { background: #fed7d7; color: #c53030; }

        .answer-display {
            margin-top: 15px;
            padding: 15px;
            background: #f0f4f8;
            border-radius: 8px;
            font-weight: bold;
            color: #2d3748;
            white-space: pre-line;
        }

        /* 答题卡样式 */
        .sheet-title {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #2d3748;
            text-align: center;
        }
        
        /* Main container no longer grid, but holds sections */
        .sheet-grid {
            display: block; 
        }

        .sheet-section-title {
            font-size: 0.95em;
            font-weight: bold;
            color: #4a5568;
            margin-top: 15px;
            margin-bottom: 8px;
            padding-bottom: 4px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .sheet-section-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-bottom: 10px;
        }

        .sheet-item {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #edf2f7;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            color: #4a5568;
            transition: all 0.2s;
            position: relative;
            border: 2px solid transparent; 
        }
        /* Question Type Indicators in Sidebar (Border Color) */
        .sheet-item.single { border-color: #bee3f8; } /* Light Blue */
        .sheet-item.multiple { border-color: #d6bcfa; } /* Light Purple */
        .sheet-item.true_false { border-color: #fefcbf; } /* Light Yellow */
        .sheet-item.material { border-color: #fed7d7; } /* Light Red */

        .sheet-item:hover {
            background: #cbd5e0;
        }
        .sheet-item.active {
            border: 2px solid #4299e1;
            background: #ebf8ff;
            color: #2b6cb0;
            font-weight: bold;
        }
        .sheet-item.correct {
            background: #48bb78;
            color: white;
        }
        .sheet-item.incorrect {
            background: #f56565;
            color: white;
        }
        
        .type-badge {
            display: inline-block;
            background: #4299e1;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        .type-badge.single { background: #4299e1; }
        .type-badge.multiple { background: #805ad5; }
        .type-badge.true_false { background: #d69e2e; }
        .type-badge.material { background: #e53e3e; }

        @media (max-width: 900px) {
            .wrapper {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                max-height: 300px;
                position: static;
                order: 2; 
            }
            .sheet-grid {
                grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            }
        }

        /* 手机端专门优化 */
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            .main-content {
                border-radius: 12px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            }
            .question-container {
                padding: 20px;
            }
            .header {
                padding: 15px;
            }
            .header h1 {
                font-size: 1.2em;
            }
            .question-text {
                font-size: 16px;
            }
            .option {
                padding: 12px;
                font-size: 15px;
            }
            .controls {
                flex-direction: row;
                gap: 10px;
            }
            .btn {
                flex: 1;
                font-size: 14px;
                padding: 12px 0;
            }
        }
    </style>
</head>
<body>
    <div class="wrapper">
        <div class="main-content">
            <div class="header">
                <h1>毛泽东思想和中国特色社会主义理论体系概论</h1>
                <p>期末练习题库</p>
            </div>
            
            <div class="chapter-selector">
                <label for="chapter-select">选择章节：</label>
                <select id="chapter-select">
                    <option value="">加载中...</option>
                </select>
            </div>
            
            <div class="question-container">
                <div class="question-header-row">
                    <div class="question-number">
                        第 <span id="current-question">1</span> 题 / <span id="total-questions">0</span> 题
                    </div>
                    <span id="question-type-badge" class="type-badge single">单选</span>
                </div>

                <div class="question-text" id="question-text"></div>
                <div class="options" id="options-container"></div>
                
                <div class="material-answer-box" id="material-answer-box"></div>
                <div class="result" id="result" style="display: none;"></div>
                <div class="answer-display" id="answer-display" style="display: none;"></div>
                
                <div class="controls">
                    <button class="btn nav-btn" id="prev-btn">上一题</button>
                    <button class="btn submit-btn" id="submit-btn" disabled>提交答案</button>
                    <button class="btn nav-btn" id="next-btn">下一题</button>
                </div>
            </div>
        </div>

        <div class="sidebar">
            <div class="sheet-title">答题卡</div>
            <div class="sheet-grid" id="sheet-grid"></div>
        </div>
    </div>

    <!-- 引用 Manifest -->
    <script src="data/manifest.js"></script>

    <script>
        // Global
        let currentChapterIndex = 0;
        let currentQuestionIndex = 0;
        let currentChapterData = null;
        
        let selectedOption = null;
        let selectedOptions = [];
        let hasAnswered = false;
        
        // State Storage
        // key="chapterIndex-questionIndex", value={selected, isCorrect}
        let answerState = {};

        // Elements
        const questionText = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const submitBtn = document.getElementById('submit-btn');
        const nextBtn = document.getElementById('next-btn');
        const prevBtn = document.getElementById('prev-btn');
        const resultDiv = document.getElementById('result');
        const answerDisplay = document.getElementById('answer-display');
        const materialAnswerBox = document.getElementById('material-answer-box');
        const currentQuestionSpan = document.getElementById('current-question');
        const totalQuestionsSpan = document.getElementById('total-questions');
        const chapterSelect = document.getElementById('chapter-select');
        const sheetGrid = document.getElementById('sheet-grid');
        const typeBadge = document.getElementById('question-type-badge');

        function initApp() {
            if (typeof quizManifest === 'undefined') {
                alert('Manifest数据未加载');
                return;
            }
            initChapterSelect();
            // Load first chapter
            if (quizManifest.length > 0) {
                loadChapter(0);
            }
            setupEventListeners();
        }

        function initChapterSelect() {
            chapterSelect.innerHTML = '';
            quizManifest.forEach((ch, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = ch.title;
                chapterSelect.appendChild(option);
            });
        }

        function loadChapter(index) {
            index = parseInt(index);
            const chInfo = quizManifest[index];
            if (!chInfo) return;

            // Check if global var exists
            const varName = chInfo.globalVar;
            
            if (window[varName]) {
                // Already loaded
                currentChapterIndex = index;
                currentChapterData = window[varName];
                currentQuestionIndex = 0;
                renderQuestion();
                renderAnswerSheet();
            } else {
                // Dynamic Load
                const script = document.createElement('script');
                script.src = chInfo.file;
                script.onload = () => {
                    currentChapterIndex = index;
                    currentChapterData = window[varName];
                    currentQuestionIndex = 0;
                    renderQuestion();
                    renderAnswerSheet();
                };
                script.onerror = () => {
                    alert('加载章节数据失败: ' + chInfo.file);
                };
                document.body.appendChild(script);
            }
        }

        function renderAnswerSheet() {
            sheetGrid.innerHTML = '';
            if (!currentChapterData || !currentChapterData.questions) return;
            const questions = currentChapterData.questions;

            // Group questions by type
            const grouped = {
                "single": { title: "单选题", items: [] },
                "multiple": { title: "多选题", items: [] },
                "true_false": { title: "判断题", items: [] },
                "material": { title: "材料分析题", items: [] }
            };

            // Order key to maintain sorting
            const typeKeys = ["single", "multiple", "true_false", "material"];

            questions.forEach((q, originalIdx) => {
                if (grouped[q.type]) {
                    grouped[q.type].items.push({ q, originalIdx });
                }
            });

            // Render
            typeKeys.forEach(type => {
                const group = grouped[type];
                if (group.items.length === 0) return;

                // Title
                const titleDiv = document.createElement('div');
                titleDiv.className = 'sheet-section-title';
                titleDiv.textContent = group.title;
                sheetGrid.appendChild(titleDiv);

                // Grid Container for this section
                const sectionGrid = document.createElement('div');
                sectionGrid.className = 'sheet-section-grid';

                group.items.forEach((obj, localIdx) => {
                    const idx = obj.originalIdx;
                    const item = document.createElement('div');
                    item.className = 'sheet-item ' + type;
                    item.textContent = localIdx + 1; // Restart numbering
                    item.id = `sheet-${idx}`; // Keep global ID for updates

                    const stateKey = `${currentChapterIndex}-${idx}`;
                    if (answerState[stateKey]) {
                        const state = answerState[stateKey];
                        if (state.isCorrect === true) item.classList.add('correct');
                        else if (state.isCorrect === false) item.classList.add('incorrect');
                        else item.classList.add('correct');
                    }

                    if (idx === currentQuestionIndex) item.classList.add('active');
                    
                    item.onclick = () => jumpToQuestion(idx);
                    sectionGrid.appendChild(item);
                });

                sheetGrid.appendChild(sectionGrid);
            });
        }

        function updateSheetHighlight() {
            const items = sheetGrid.querySelectorAll('.sheet-item');
            items.forEach((item, idx) => {
                if (idx === currentQuestionIndex) item.classList.add('active');
                else item.classList.remove('active');
            });
        }

        function jumpToQuestion(index) {
            currentQuestionIndex = index;
            renderQuestion();
            updateSheetHighlight();
        }

        function renderQuestion() {
            if (!currentChapterData) return;
            const questions = currentChapterData.questions;
            
            if (currentQuestionIndex < 0) currentQuestionIndex = 0;
            if (currentQuestionIndex >= questions.length) currentQuestionIndex = questions.length - 1;

            const question = questions[currentQuestionIndex];
            
            // Text
            questionText.textContent = question.question;
            currentQuestionSpan.textContent = currentQuestionIndex + 1;
            totalQuestionsSpan.textContent = questions.length;

            // Type Badge
            updateTypeBadge(question.type);

            // Restore State
            const stateKey = `${currentChapterIndex}-${currentQuestionIndex}`;
            const savedState = answerState[stateKey];
            hasAnswered = !!savedState;
            
            if (savedState) {
                selectedOption = savedState.selected;
                selectedOptions = Array.isArray(savedState.selected) ? savedState.selected : [];
            } else {
                selectedOption = null;
                selectedOptions = [];
            }

            optionsContainer.innerHTML = '';
            materialAnswerBox.style.display = 'none';

            if (question.type === "material") {
                renderMaterial(question, savedState);
            } else if (question.type === "true_false") {
                renderTrueFalse(question, savedState);
            } else {
                renderOptions(question, savedState);
            }

            // Result
            if (savedState && question.type !== "material") {
                showResult(savedState.isCorrect, question.answer);
            } else {
                resultDiv.style.display = 'none';
                answerDisplay.style.display = 'none';
            }

            // Nav
            prevBtn.disabled = currentQuestionIndex === 0;
            nextBtn.disabled = currentQuestionIndex === questions.length - 1;
        }

        function updateTypeBadge(type) {
            typeBadge.className = 'type-badge ' + type;
            let text = "单选";
            if (type === "multiple") text = "多选";
            if (type === "true_false") text = "判断";
            if (type === "material") text = "材料分析";
            typeBadge.textContent = text;
        }

        function renderMaterial(question, savedState) {
            submitBtn.textContent = hasAnswered ? "已查看答案" : "查看参考答案";
            submitBtn.style.display = hasAnswered ? 'none' : 'inline-flex';
            submitBtn.disabled = hasAnswered; 
            
            if (hasAnswered) {
                materialAnswerBox.textContent = "【参考答案】\n" + question.answer;
                materialAnswerBox.style.display = 'block';
            } else {
                submitBtn.disabled = false;
            }
        }

        function renderTrueFalse(question, savedState) {
            const opts = ["正确", "错误"];
            opts.forEach(opt => {
                const btn = document.createElement('div');
                btn.className = 'option';
                btn.textContent = opt;
                btn.dataset.val = opt;

                if (savedState) {
                    btn.style.cursor = 'default';
                    if (opt === question.answer) btn.classList.add('correct');
                    else if (opt === savedState.selected && savedState.selected !== question.answer) btn.classList.add('incorrect');
                } else {
                    btn.onclick = () => {
                        if(hasAnswered) return;
                        // Single Select Logic
                        const siblings = optionsContainer.querySelectorAll('.option');
                        siblings.forEach(s => s.classList.remove('selected'));
                        btn.classList.add('selected');
                        selectedOption = opt;
                        submitBtn.disabled = false;
                    };
                }
                optionsContainer.appendChild(btn);
            });
            updateSubmitButton(savedState);
        }

        function renderOptions(question, savedState) {
            // Usually options A, B, C, D
            // Use question.options if available
            // If not available (extraction issue?), try to fake it?
            let opts = question.options || [];
            if (opts.length === 0) {
                 // Fallback if no options parsed but single/multi?
                 // Usually extraction guarantees options.
                 const div = document.createElement('div');
                 div.style.color = 'red';
                 div.textContent = '(选项解析失败，请查看题目文本)';
                 optionsContainer.appendChild(div);
                 return;
            }

            opts.forEach((optText, idx) => {
                const letter = String.fromCharCode(65 + idx);
                const btn = document.createElement('div');
                btn.className = 'option';
                btn.textContent = `${letter}. ${optText}`;
                btn.dataset.val = letter;

                if (savedState) {
                    btn.style.cursor = 'default';
                    // Check Logic
                    if (question.type === "multiple") {
                         const isCorrectOption = question.answer.includes(letter);
                         const isSelected = savedState.selected.includes(letter);
                         if (isCorrectOption) btn.classList.add('correct');
                         if (isSelected && !isCorrectOption) btn.classList.add('incorrect');
                         if (isSelected && isCorrectOption) { /* already green */ }
                    } else {
                         if (letter === question.answer) btn.classList.add('correct');
                         else if (letter === savedState.selected && savedState.selected !== question.answer) btn.classList.add('incorrect');
                    }
                } else {
                    btn.onclick = () => {
                        if (hasAnswered) return;
                        if (question.type === "multiple") {
                            // Toggle
                            if (selectedOptions.includes(letter)) {
                                selectedOptions = selectedOptions.filter(v => v !== letter);
                                btn.classList.remove('selected', 'multiple-selected');
                            } else {
                                selectedOptions.push(letter);
                                btn.classList.add('selected', 'multiple-selected');
                            }
                            submitBtn.disabled = selectedOptions.length === 0;
                        } else {
                            // Single
                            const siblings = optionsContainer.querySelectorAll('.option');
                            siblings.forEach(s => s.classList.remove('selected'));
                            btn.classList.add('selected');
                            selectedOption = letter;
                            submitBtn.disabled = false;
                        }
                    };
                }
                optionsContainer.appendChild(btn);
            });
            updateSubmitButton(savedState);
        }

        function updateSubmitButton(savedState) {
            if (savedState) {
                submitBtn.style.display = 'none';
            } else {
                submitBtn.style.display = 'inline-flex';
                submitBtn.textContent = "提交答案";
                submitBtn.disabled = true; // wait for selection
            }
        }

        function submitAnswer() {
            if (hasAnswered) return;
            const question = currentChapterData.questions[currentQuestionIndex];
            
            let isCorrect = false;
            let userAnswer = null;

            if (question.type === "material") {
                isCorrect = true;
                userAnswer = "viewed";
                materialAnswerBox.textContent = "【参考答案】\n" + question.answer;
                materialAnswerBox.style.display = 'block';
            } else if (question.type === "multiple") {
                userAnswer = selectedOptions.sort().join("");
                isCorrect = userAnswer === question.answer;
            } else {
                userAnswer = selectedOption;
                isCorrect = userAnswer === question.answer;
            }

            hasAnswered = true;
            answerState[`${currentChapterIndex}-${currentQuestionIndex}`] = {
                selected: userAnswer,
                isCorrect: isCorrect
            };

            renderQuestion(); // Re-render to show result styles
            
            // Update Sheet
            const item = document.getElementById(`sheet-${currentQuestionIndex}`);
            if (item) {
                item.classList.remove('correct', 'incorrect');
                if (isCorrect) item.classList.add('correct');
                else item.classList.add('incorrect');
            }
        }

        function showResult(isCorrect, ans) {
            resultDiv.style.display = 'block';
            answerDisplay.style.display = 'block';
            
            if (isCorrect) {
                resultDiv.textContent = '回答正确！✓';
                resultDiv.className = 'result correct';
            } else {
                resultDiv.textContent = '回答错误！✗';
                resultDiv.className = 'result incorrect';
            }
            answerDisplay.textContent = `正确答案：${ans}`;
        }

        function setupEventListeners() {
            submitBtn.addEventListener('click', submitAnswer);
            nextBtn.addEventListener('click', () => {
                const total = currentChapterData.questions.length;
                if (currentQuestionIndex < total - 1) {
                    jumpToQuestion(currentQuestionIndex + 1);
                }
            });
            prevBtn.addEventListener('click', () => {
                if (currentQuestionIndex > 0) {
                    jumpToQuestion(currentQuestionIndex - 1);
                }
            });
            chapterSelect.addEventListener('change', (e) => {
                loadChapter(e.target.value);
            });
        }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
